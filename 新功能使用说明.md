# 新功能使用说明

## 功能概述

本次更新添加了两个重要功能：

### 1. 域名黑名单功能
- 可以将指定域名添加到黑名单
- 黑名单中的域名即使引入了广告脚本，也不会弹出广告
- 支持添加、删除黑名单域名

### 2. 广告弹出频率控制
- 为主广告和次要广告分别添加了"每日只弹出一次"的开关
- 开启后，用户每天只会看到一次广告（基于 localStorage）
- 关闭后，广告显示频率恢复到原来的行为

---

## 使用指南

### 一、域名黑名单管理

#### 访问位置
- 登录管理后台
- 点击左侧菜单的"域名黑名单"选项

#### 添加域名到黑名单
1. 在"添加域名到黑名单"区域
2. 输入要屏蔽的域名（例如：`example.com`）
3. 点击"添加到黑名单"按钮
4. 添加成功后，该域名会出现在下方的黑名单列表中

#### 移除域名
1. 在黑名单列表中找到要移除的域名
2. 点击该行右侧的"移除"按钮
3. 确认后即可移除

#### 效果说明
- 黑名单中的域名不会显示任何广告（主广告和次要广告都不显示）
- 该功能在后端实现，前端脚本会自动识别
- 添加/移除操作立即生效

---

### 二、广告弹出频率控制

#### 访问位置
- 登录管理后台
- 点击左侧菜单的"广告管理"选项
- 查看顶部筛选区域的"投放控制"部分

#### 设置说明

**投放控制区域包含以下开关：**

1. **总开关** - 控制所有广告的总开关
2. **主广告** - 控制主广告是否投放
3. **次要广告** - 控制次要广告是否投放
4. **频率控制**（新增）：
   - **主广告每日一次** - 开启后，主广告每天只弹出一次
   - **次要广告每日一次** - 开启后，次要广告每天只弹出一次

#### 使用步骤
1. 确保"总开关"处于开启状态
2. 根据需要开启或关闭"主广告每日一次"开关
3. 根据需要开启或关闭"次要广告每日一次"开关
4. 设置立即生效

#### 工作原理
- 开关状态保存在服务器端
- 前端脚本使用浏览器的 `localStorage` 记录用户当天是否已看过广告
- 每天零点后自动重置，用户可以再次看到广告
- 如果关闭开关，广告恢复正常弹出频率

---

## 技术实现说明

### 数据库变更
1. 新增 `domain_blacklist` 表用于存储黑名单域名
2. 在 `settings` 表中新增两个配置项：
   - `main_ad_once_per_day`：主广告频率控制
   - `secondary_ad_once_per_day`：次要广告频率控制

### API 接口
新增以下接口：
- `GET /domains/blacklist` - 获取黑名单列表
- `POST /domains/blacklist` - 添加域名到黑名单
- `DELETE /domains/blacklist/{id}` - 从黑名单移除域名
- `GET /domains/blacklist/check?domain=xxx` - 检查域名是否在黑名单中

修改的接口：
- `GET /ads/random_pair` - 现在会检查域名黑名单并返回频率控制设置
- `GET /ads/settings` - 现在包含频率控制字段
- `PATCH /ads/settings` - 现在支持更新频率控制设置

### 前端变更
1. 新增 `DomainManagement.jsx` 页面用于管理域名黑名单
2. 更新 `AdManagement.jsx` 页面，添加频率控制开关
3. 更新 `ad-script.js` 广告脚本，实现：
   - 域名检查（发送当前域名到服务器）
   - 频率控制（使用 localStorage 记录显示状态）

---

## 注意事项

1. **域名格式**：输入域名时只需要输入主域名即可，例如 `example.com`，不需要包含协议（http://）或路径
2. **频率控制的限制**：
   - 基于用户浏览器的 localStorage 实现
   - 如果用户清除浏览器数据，计数会重置
   - 如果用户使用无痕模式或不同浏览器，每个环境独立计数
3. **总开关优先级**：当总开关关闭时，所有子开关（包括频率控制）都会被禁用

---

## 测试建议

### 测试域名黑名单
1. 添加一个测试域名到黑名单
2. 在该域名的网站上引入广告脚本
3. 确认广告不会弹出
4. 从黑名单移除该域名
5. 刷新页面，确认广告正常显示

### 测试频率控制
1. 开启"主广告每日一次"开关
2. 访问引入了广告脚本的网站
3. 确认主广告显示
4. 刷新页面多次
5. 确认主广告不再显示
6. 打开浏览器控制台，清除 localStorage 中的 `ad_main_last_shown` 项
7. 刷新页面，确认主广告重新显示

---

## 常见问题

**Q: 黑名单设置后多久生效？**  
A: 立即生效。下次该域名的访问者请求广告时，服务器会检查黑名单并拒绝返回广告。

**Q: 频率控制的"每日"是如何计算的？**  
A: 基于访问者本地时间的日期（YYYY-MM-DD 格式），每天零点后自动重置。

**Q: 如果用户使用隐私模式会怎样？**  
A: 隐私模式下 localStorage 通常在关闭浏览器后清除，因此频率控制可能无法持久化到第二天。

**Q: 可以批量导入黑名单吗？**  
A: 当前版本不支持批量导入，需要一个一个添加。如有需要，可以后续添加此功能。

---

## 部署说明

### 后端部署
1. 确保数据库更新：新的表和配置项会在应用启动时自动创建
2. 重启 Python 服务器：
   ```bash
   cd server/ads-server
   python run.py
   ```

### 前端部署
1. 构建前端：
   ```bash
   cd admin
   pnpm install  # 如果有新依赖
   pnpm run build
   ```
2. 部署 `dist` 目录到 Web 服务器

### 广告脚本更新
- 确保网站引用的是更新后的 `ad-script.js`
- 如果使用了 CDN 缓存，需要清除缓存或更新版本号

---

如有任何问题，请联系技术支持团队。

